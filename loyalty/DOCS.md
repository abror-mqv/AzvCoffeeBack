# Документация API системы лояльности

## Общая информация

API системы лояльности позволяет:
- Клиентам генерировать QR-коды для получения бонусов
- Бариста создавать транзакции с начислением/списанием бонусов
- Отслеживать историю транзакций

## Базовый URL

```
/api/loyalty/
```

## Аутентификация

Все запросы требуют аутентификации по токену. Добавьте заголовок:
```
Authorization: Token ваш_токен
```

## Эндпоинты

### 1. Генерация кода лояльности

**URL**: `/api/loyalty/code/`  
**Метод**: `POST`  
**Доступ**: Только для клиентов  
**Тело запроса**: Пустое  

**Пример успешного ответа (201 Created):**
```json
{
    "id": 1,
    "code": "123456",
    "created_at": "2025-07-24T19:30:00+06:00",
    "expires_at": "2025-07-24T19:45:00+06:00",
    "is_active": true
}
```

---

### 2. Генерация кода для бесплатного кофе

**URL**: `/api/loyalty/free-coffee-code/`  
**Метод**: `POST`  
**Доступ**: Только для клиентов  
**Тело запроса**: Пустое  

**Ошибки:**
- `400 Bad Request` - если у клиента меньше 7 кофе в истории

**Пример успешного ответа (201 Created):**
```json
{
    "id": 2,
    "code": "789012",
    "created_at": "2025-07-24T19:30:00+06:00",
    "expires_at": "2025-07-24T19:45:00+06:00",
    "is_active": true,
    "is_free_coffee_redemption": true
}
```

---

### 3. Проверка кода лояльности

**URL**: `/api/loyalty/verify-code/`  
**Метод**: `POST`  
**Доступ**: Только для бариста  
**Тело запроса:**
```json
{
    "code": "123456"
}
```

**Пример успешного ответа (200 OK):**
```json
{
    "success": true,
    "user": {
        "id": 1,
        "phone": "+996555123456",
        "first_name": "Иван",
        "last_name": "Иванов",
        "points": 1000,
        "coffee_count": 3,
        "coffee_to_next_free": 4
    }
}
```

---

### 4. Создание транзакции

**URL**: `/api/loyalty/transactions/`  
**Метод**: `POST`  
**Доступ**: Только для бариста  
**Тело запроса:**
```json
{
    "code": "123456",
    "amount": 1000,
    "points_to_use": 200,
    "coffee_quantity": 2
}
```

**Параметры:**
- `code` (обязательный) - 6-значный код лояльности
- `amount` (обязательный) - сумма чека в сомах
- `points_to_use` (обязательный) - количество бонусов для списания (может быть 0)
- `coffee_quantity` (опциональный, по умолчанию 0) - количество кофе в заказе

**Ошибки:**
- `400 Bad Request` - если недостаточно бонусов или неверный код
- `403 Forbidden` - если пользователь не бариста
- `400 Bad Request` - если бариста не привязан к кофейне

**Пример успешного ответа (201 Created):**
```json
{
    "transaction": {
        "id": 1,
        "user": 1,
        "user_info": {
            "id": 1,
            "phone": "+996555123456",
            "first_name": "Иван",
            "last_name": "Иванов"
        },
        "barista": 2,
        "barista_info": {
            "id": 2,
            "phone": "+996777123456",
            "first_name": "Мария",
            "last_name": "Петрова"
        },
        "coffee_shop": 1,
        "transaction_type": "earning",
        "amount": 1000,
        "amount_in_currency": 1000,
        "points_used": 200,
        "points_earned": 40,
        "final_amount": 800,
        "created_at": "2025-07-24T19:30:00+06:00"
    },
    "user": {
        "id": 1,
        "phone": "+996555123456",
        "first_name": "Иван",
        "last_name": "Иванов",
        "points": 840,
        "coffee_count": 5,
        "coffee_to_next_free": 2
    }
}
```

---

### 5. История транзакций

**URL**: `/api/loyalty/transactions/`  
**Метод**: `GET`  
**Доступ**: Для всех аутентифицированных пользователей  

**Параметры запроса:**
- `limit` (опциональный) - ограничение количества записей
- `offset` (опциональный) - смещение для пагинации

**Пример успешного ответа (200 OK):**
```json
{
    "count": 10,
    "next": "/api/loyalty/transactions/?limit=5&offset=5",
    "previous": null,
    "results": [
        {
            "id": 1,
            "user": 1,
            "user_info": {
                "id": 1,
                "phone": "+996555123456",
                "first_name": "Иван",
                "last_name": "Иванов"
            },
            "barista": 2,
            "barista_info": {
                "id": 2,
                "phone": "+996777123456",
                "first_name": "Мария",
                "last_name": "Петрова"
            },
            "coffee_shop": 1,
            "transaction_type": "earning",
            "amount": 1000,
            "amount_in_currency": 1000,
            "points_used": 200,
            "points_earned": 40,
            "final_amount": 800,
            "created_at": "2025-07-24T19:30:00+06:00"
        }
    ]
}
```

## Коды ошибок

| Код | Описание |
|-----|----------|
| 400 | Неверные параметры запроса |
| 401 | Не авторизован |
| 403 | Доступ запрещен |
| 404 | Ресурс не найден |
| 500 | Внутренняя ошибка сервера |
