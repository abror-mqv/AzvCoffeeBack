# Документация API (core)

## Эндпоинты

### 1. Авторизация управляющего
**POST** `/api/manager/login/`

**Параметры запроса:**
```json
{
  "phone": "+79998887766",
  "password": "your_manager_password"
}
```
**Ответ (успех):**
```json
{
  "token": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
}
```
**Ответ (ошибка):**
```json
{
  "error": "Неверные данные или недостаточно прав"
}
```

---

### 2. Регистрация бариста или старшего бариста
**POST** `/api/manager/register-barista/`

**Заголовок:**
```
Authorization: Token <token>
```
**Параметры запроса:**
```json
{
  "phone": "+79991112233",
  "role": "barista",  // или "senior_barista"
  "coffee_shop_id": 1,
  "password": "qwerty123",
  "first_name": "Иван",
  "last_name": "Иванов"
}
```
**Ответ (успех):**
```json
{
  "success": "Бариста создан",
  "user_id": 2
}
```
**Ответ (ошибка):**
```json
{
  "error": "Необходимы телефон, пароль, имя, фамилия и ID заведения"
}
```
- `first_name` — имя бариста
- `last_name` — фамилия бариста
- `password` — пароль (сохраняется в raw виде, небезопасно)

---

### 3. Регистрация заведения
**POST** `/api/manager/register-coffeeshop/`

**Заголовок:**
```
Authorization: Token <token>
```
**Параметры запроса:**
```json
{
  "name": "Кофейня на Ленина",
  "address": "г. Москва, ул. Ленина, д. 1",
  "latitude": 55.754167,
  "longitude": 37.62
}
```
**Ответ (успех):**
```json
{
  "success": "Заведение создано",
  "coffee_shop_id": 1
}
```
**Ответ (ошибка):**
```json
{
  "error": "Необходимо указать название и адрес"
}
```
- `latitude` и `longitude` — координаты для отображения на карте (опционально)

---

### 4. Получение списка заведений
**GET** `/api/coffeeshops/`

**Заголовок:**
```
Authorization: Token <token>
```
**Ответ:**
```json
[
  {
    "id": 1,
    "name": "Кофейня на Ленина",
    "address": "г. Москва, ул. Ленина, д. 1",
    "latitude": 55.754167,
    "longitude": 37.62,
    "opening_hours": {
      "0": {"open": "09:00", "close": "22:00"},
      "1": {"open": "09:00", "close": "22:00"},
      "2": {"open": "09:00", "close": "22:00"},
      "3": {"open": "09:00", "close": "22:00"},
      "4": {"open": "09:00", "close": "22:00"},
      "5": {"open": "10:00", "close": "20:00"},
      "6": {"open": "10:00", "close": "20:00"}
    },
    "responsible_senior_barista_phone": "+79991112233",
    "staff_count": 5
  },
  // ... другие заведения ...
]
```
- `latitude` и `longitude` — координаты для отображения на карте
- `opening_hours` — часы работы по дням недели (0 - понедельник, 6 - воскресенье)
- `staff_count` — количество бариста и старших бариста, привязанных к заведению
- `responsible_senior_barista_phone` — телефон ответственного старшего бариста (или null, если не назначен)

---

### 5. Получение всех бариста и старших бариста
**GET** `/api/baristas/`

**Заголовок:**
```
Authorization: Token <token>
```
**Ответ:**
```json
[
  {
    "id": 2,
    "phone": "+79991112233",
    "role": "barista",
    "first_name": "Иван",
    "last_name": "Иванов",
    "coffee_shop_id": 1,
    "coffee_shop_name": "Кофейня на Ленина",
    "password": "qwerty123"
  },
  // ... другие бариста ...
]
```
- `password` — хранится в raw виде (по требованию, небезопасно)
- `coffee_shop_id` и `coffee_shop_name` — точка, к которой привязан бариста
- Только для управляющего

---

### 6. Получение списка всех клиентов
**GET** `/api/clients/`

**Заголовок:**
```
Authorization: Token <token>
```

**Параметры запроса (опциональные):**
- `page` — номер страницы (по умолчанию 1)
- `page_size` — количество записей на странице (по умолчанию 10, максимум 100)
- `search` — поисковый запрос (ищет по имени, фамилии и телефону)
- `min_spent` — минимальная сумма трат в рублях
- `min_coffee` — минимальное количество купленных кофе

**Пример запроса:**
```
/api/clients/?page=1&page_size=20&search=Иван&min_spent=1000&min_coffee=5
```

**Ответ:**
```json
{
  "count": 42,
  "next": "http://localhost:8000/api/clients/?page=2&page_size=10",
  "previous": null,
  "results": [
    {
      "id": 3,
      "phone": "+79998887766",
      "first_name": "Анна",
      "last_name": "Петрова",
      "birth_date": "1990-05-15",
      "points": 150,
      "coffee_count": 12,
      "total_spent": 240000,
      "total_spent_rubles": 2400.0,
      "free_coffee_count": 1,
      "registration_date": "2023-10-15"
    },
    // ... другие клиенты ...
  ]
}
```

**Поля ответа:**
- `count` — общее количество записей, соответствующих запросу
- `next` — URL следующей страницы (null, если текущая страница последняя)
- `previous` — URL предыдущей страницы (null, если текущая страница первая)
- `results` — массив клиентов на текущей странице
  - `total_spent_rubles` — общий чек в рублях
  - `free_coffee_count` — количество бесплатных кофе (каждое 7-е кофе бесплатно)
  - `registration_date` — дата регистрации в формате YYYY-MM-DD

- Только для управляющего

---

### 7. Закрепление бариста за заведением (и назначение ответственным)
**POST** `/api/assign-barista/`

**Заголовок:**
```
Authorization: Token <token>
```
**Параметры запроса:**
```json
{
  "barista_id": 2,
  "coffee_shop_id": 1,
  "is_responsible": true
}
```
- `barista_id` — id бариста или старшего бариста
- `coffee_shop_id` — id заведения
- `is_responsible` — true/false, если true — назначить ответственным (старшим бариста)

**Ответ (успех):**
```json
{
  "success": "Бариста закреплён за заведением",
  "responsible": true
}
```
**Ответ (ошибка):**
```json
{
  "error": "Бариста не найден"
}
```
- За каждым заведением может быть только один ответственный старший бариста (назначение нового перезапишет предыдущего)
- Только для управляющего

---

### 8. Редактирование баристы
**POST** `/api/edit-barista/`

**Заголовок:**
```
Authorization: Token <token>
```
**Параметры запроса:**
```json
{
  "barista_id": 2,
  "phone": "+79991112233",
  "first_name": "Иван",
  "last_name": "Иванов",
  "role": "senior_barista",
  "password": "newpassword"
}
```
- `barista_id` — id бариста или старшего бариста (обязателен)
- Остальные поля — опциональны, будут изменены только если переданы
- `password` — сохраняется в raw виде (по требованию, небезопасно)

**Ответ (успех):**
```json
{
  "success": "Бариста обновлён"
}
```
**Ответ (ошибка):**
```json
{
  "error": "Пользователь с таким телефоном уже существует"
}
```
- Только для управляющего

---

### 9. Редактирование заведения
**POST** `/api/edit-coffeeshop/`

**Заголовок:**
```
Authorization: Token <token>
```
**Параметры запроса:**
```json
{
  "coffee_shop_id": 1,
  "name": "Новая кофейня",
  "address": "г. Москва, ул. Новая, д. 2",
  "latitude": 55.760000,
  "longitude": 37.630000
}
```
- `coffee_shop_id` — id заведения (обязателен)
- `name`, `address`, `latitude`, `longitude` — опциональны, будут изменены только если переданы

**Ответ (успех):**
```json
{
  "success": "Заведение обновлено"
}
```
**Ответ (ошибка):**
```json
{
  "error": "Заведение не найдено"
}
```
- Только для управляющего

---

### 10. Управление часами работы заведения
**POST** `/api/coffeeshop/working-hours/`

**Заголовок:**
```
Authorization: Token <token>
```
**Параметры запроса:**
```json
{
  "coffee_shop_id": 1,
  "day_of_week": 0,
  "opening_time": "09:00",
  "closing_time": "22:00"
}
```
- `coffee_shop_id` — id заведения (обязателен)
- `day_of_week` — день недели (0 - понедельник, 6 - воскресенье)
- `opening_time` — время открытия в формате "HH:MM"
- `closing_time` — время закрытия в формате "HH:MM"

**Ответ (успех):**
```json
{
  "success": "Часы работы для Понедельник установлены",
  "day_of_week": 0,
  "opening_time": "09:00",
  "closing_time": "22:00"
}
```
**Ответ (ошибка):**
```json
{
  "error": "Время должно быть в формате HH:MM"
}
```
- Только для управляющего

---

### 11. Получение часов работы заведения
**GET** `/api/coffeeshop/working-hours/?coffee_shop_id=1&day_of_week=0`

**Заголовок:**
```
Authorization: Token <token>
```
**Параметры запроса:**
- `coffee_shop_id` — id заведения (обязателен)
- `day_of_week` — день недели (опционально, если не указан — вернутся все дни)

**Ответ для конкретного дня:**
```json
{
  "day_of_week": 0,
  "day_name": "Понедельник",
  "hours": {
    "open": "09:00",
    "close": "22:00"
  }
}
```

**Ответ для всех дней:**
```json
{
  "0": {
    "day_name": "Понедельник",
    "open": "09:00",
    "close": "22:00"
  },
  "1": {
    "day_name": "Вторник",
    "open": "09:00",
    "close": "22:00"
  },
  // ... другие дни ...
}
```
- Если для какого-то дня часы не установлены, он может отсутствовать в ответе

---

### 12. Авторизация бариста/старшего бариста
**POST** `/api/barista/login/`

**Параметры запроса:**
```json
{
  "phone": "+79991112233",
  "password": "qwerty123"
}
```

**Ответ (успех):**
```json
{
  "token": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "user": {
    "id": 2,
    "phone": "+79991112233",
    "role": "barista",
    "first_name": "Иван",
    "last_name": "Иванов"
  }
}
```

**Ответ (ошибка - неверный пароль):**
```json
{
  "error": "Неверный пароль"
}
```

**Ответ (ошибка - бариста не найден):**
```json
{
  "error": "Бариста с таким номером не найден"
}
```

---

### 13. Получение информации о бариста
**GET** `/api/barista/info/`

**Заголовок:**
```
Authorization: Token <token>
```

**Ответ:**
```json
{
  "id": 2,
  "phone": "+79991112233",
  "role": "barista",
  "first_name": "Иван",
  "last_name": "Иванов",
  "coffee_shop": 1,
  "coffee_shop_name": "Кофейня на Ленина",
  "is_responsible": false
}
```

**Поля ответа:**
- `coffee_shop` — ID заведения, к которому привязан бариста (или null, если не привязан)
- `coffee_shop_name` — название заведения, к которому привязан бариста
- `is_responsible` — является ли бариста ответственным за заведение (только для старших бариста)

**Ответ (ошибка - не бариста):**
```json
{
  "error": "Доступ только для бариста и старших бариста"
}
```

---

## Клиентские эндпоинты

### 14. Проверка номера телефона клиента
**POST** `/api/client/check-phone/`

**Параметры запроса:**
```json
{
  "phone": "+79998887766"
}
```

**Ответ (клиент существует):**
```json
{
  "status": "authorized",
  "message": "Клиент успешно авторизован",
  "token": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "user": {
    "id": 3,
    "phone": "+79998887766",
    "first_name": "Анна",
    "last_name": "Петрова",
    "birth_date": "1990-05-15",
    "points": 150,
    "coffee_count": 12,
    "total_spent": 240000
  }
}
```

**Ответ (номер не найден):**
```json
{
  "status": "registration_required",
  "message": "Номер телефона не найден. Требуется регистрация."
}
```

**Ответ (номер занят другой ролью):**
```json
{
  "status": "error",
  "message": "Номер телефона уже используется в системе"
}
```

---

### 15. Регистрация нового клиента
**POST** `/api/client/register/`

**Параметры запроса:**
```json
{
  "phone": "+79998887766",
  "first_name": "Анна",
  "last_name": "Петрова",
  "birth_date": "1990-05-15"
}
```

**Ответ (успех):**
```json
{
  "status": "registered",
  "message": "Клиент успешно зарегистрирован",
  "token": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "user": {
    "id": 3,
    "phone": "+79998887766",
    "first_name": "Анна",
    "last_name": "Петрова",
    "birth_date": "1990-05-15",
    "points": 0,
    "coffee_count": 0,
    "total_spent": 0
  }
}
```

**Ответ (ошибка):**
```json
{
  "status": "error",
  "message": "Ошибка при регистрации: Номер телефона уже используется в системе"
}
```

---

### 16. Получение информации о клиенте
**GET** `/api/client/info/`

**Заголовок:**
```
Authorization: Token <token>
```

**Ответ:**
```json
{
  "id": 3,
  "phone": "+79998887766",
  "first_name": "Анна",
  "last_name": "Петрова",
  "birth_date": "1990-05-15",
  "points": 150,
  "coffee_count": 12,
  "total_spent": 240000,
  "free_coffee_count": 1,
  "coffee_to_next_free": 2,
  "total_spent_rubles": 2400.0
}
```

**Поля ответа:**
- `points` — количество баллов клиента
- `coffee_count` — общее количество купленных кофе
- `total_spent` — общий чек в копейках
- `free_coffee_count` — количество бесплатных кофе (каждое 7-е кофе бесплатно)
- `coffee_to_next_free` — количество кофе до следующего бесплатного
- `total_spent_rubles` — общий чек в рублях

#### Обновление информации о клиенте
**PATCH/PUT** `/api/client/info/`

**Заголовок:**
```
Authorization: Token <token>
```

**Тело запроса (любые из полей, частично для PATCH):**
```json
{
  "phone": "+996500000001",
  "first_name": "Айбек",
  "last_name": "Канатбеков"
}
```

**Ответ (успех):** 200 — объект клиента в том же формате, что и GET `/api/client/info/`.

**Ошибки:**
- 403 — если текущий пользователь не клиент: `{ "error": "Доступ только для клиентов" }`
- 400 — если номер телефона занят: `{ "error": "Пользователь с таким телефоном уже существует" }`

---

## Примечания
- Все ответы возвращаются в формате JSON.
- Для защищённых эндпоинтов требуется токен управляющего или клиента.
- Клиентские endpoints не требуют авторизации для регистрации и проверки номера.
- Для получения информации о клиенте требуется токен авторизации клиента.
- Координаты кофеен (latitude, longitude) используются для отображения на картах.
- Часы работы хранятся в формате JSON с ключами по дням недели (0-6).
- Документация будет дополняться по мере развития API. 








